<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Docker Proxy: Synopsis</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Docker Proxy
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md__r_e_a_d_m_e.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Synopsis </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This is an API rest proxy. It's handling PUT/POST requests to handle docker container management</p>
<h2>Code Example</h2>
<p>Function creating the container</p>
<div class="fragment"><div class="line">#creating the container</div><div class="line">        response = make_connection.connect_docker_server().create_container(image=image_name, hostname=name_id,</div><div class="line">                                                                            ports=internal_port_udp_tcp_removed,</div><div class="line">                                                                            environment={&#39;ACCESS_TOKEN&#39;: plex_secret_token,</div><div class="line">                                                                                         &#39;SERVER_NAME&#39;: plex_server_name,</div><div class="line">                                                                                         &#39;MANUAL_PORT&#39;: my_dict_port_list.values()[0]},</div><div class="line">                                                                            host_config=make_connection.connect_docker_server().create_host_config(</div><div class="line">                                                                                cap_add=[cap_add_value],</div><div class="line">                                                                                binds=[where_to_mount],</div><div class="line">                                                                                port_bindings=my_dict_port_list,</div><div class="line">                                                                                privileged=privileged, cpuset_cpus=&#39;0&#39;, cpu_period=100000,</div><div class="line">                                                                                mem_limit=parser.config_params(&#39;container_settings&#39;)[&#39;memory&#39;]),</div><div class="line">                                                                            command=exec_this, name=name_id)</div><div class="line">        #starting the container</div><div class="line">        make_connection.connect_docker_server().start(container=response.get(&#39;Id&#39;))</div></div><!-- fragment --><p>Ex:</p>
<div class="fragment"><div class="line">~curl -i -H &quot;secretkey:1234&quot; -H &quot;Content-Type: application/json&quot; -X POST -d &#39;{&quot;username&quot;:&quot;pulifricimare&quot;,&quot;password&quot;: &quot;123456789&quot;, &quot;options&quot;: </div><div class="line">{&quot;diskspace&quot;:&quot;512M&quot;,&quot;service&quot;:&quot;plex&quot;},&quot;plex&quot;:{&quot;plex_secret_token&quot;:&quot;41Zs4dupjB2KeVskbQyb&quot;,&quot;plex_server_name&quot;:&quot;localhost_test&quot;}}&#39; http://localhost:5000/api/seedboxes/new/plex1</div></div><!-- fragment --><h2>Motivation</h2>
<p>In order to have full control from a frontend to the docker server, a proxy able to hande a specific set of REST API calls had to be created</p>
<h2>Installation</h2>
<p>Code must be installed in /opt/proxy and runned using gunicorn for better performance</p>
<h3>Gunicorn</h3>
<p>Sample of gunicorn.service file</p>
<div class="fragment"><div class="line">[Unit]</div><div class="line">Description=gunicorn daemon</div><div class="line">After=network.target</div><div class="line">After=syslog.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">User=sysadmin</div><div class="line">Group=sysadmin</div><div class="line"></div><div class="line">Enviroment=sitedir=/opt/proxy</div><div class="line">ExecStart=/usr/bin/gunicorn --bind 127.0.0.1:4000 --chdir /opt/proxy  wsgi:app --log-file /var/log/gunicorn/gunicorn.log --log-level DEBUG</div><div class="line">ExecReload=/bin/kill -s HUP $MAINPID</div><div class="line">ExecStop=/bin/kill -s TERM $MAINPID</div><div class="line">PrivateTmp=true</div></div><!-- fragment --> <h3>Celery support</h3>
<p>Two instances must be started.</p>
<div class="fragment"><div class="line">celery2 worker -A my_proxy.celery --loglevel=info</div></div><!-- fragment --><div class="fragment"><div class="line">python my_proxy.py</div></div><!-- fragment --><p>As a requirement, redis server must be running. Take a loon at</p>
<div class="fragment"><div class="line">app.config[&#39;CELERY_BROKER_URL&#39;] = &#39;redis://192.168.98.17:6379/0&#39;</div><div class="line">app.config[&#39;CELERY_RESULT_BACKEND&#39;] = &#39;redis://192.168.98.17:6379/0&#39;</div></div><!-- fragment --><h3>Database</h3>
<h4>Mysql</h4>
<p>For MYSQL <b>config.ini</b> must be changed</p>
<div class="fragment"><div class="line">[dbname]</div><div class="line">location_name_db: mysql://proxy_db_user:9911@localhost/proxy_db</div></div><!-- fragment --><h4>Sqlite3</h4>
<p>For sqlite3 <b>config.ini</b> must be changed</p>
<div class="fragment"><div class="line">[dbname]</div><div class="line">location_name_db: sqlite:////tmp/test.db</div></div><!-- fragment --><h4>DB init</h4>
<p>In order to install db tables</p>
<div class="fragment"><div class="line">from models import models</div><div class="line">models.db.create_all()</div></div><!-- fragment --><h4>Docker server settings</h4>
<p>Docker server storage must be in **/data/docker**</p>
<p>Sample of the docker.service configuration file</p>
<div class="fragment"><div class="line">[Unit]</div><div class="line">Description=Docker Application Container Engine</div><div class="line">Documentation=https://docs.docker.com</div><div class="line">After=network.target docker.socket</div><div class="line">Requires=docker.socket</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">ExecStart=/usr/bin/dockerd -g /data/docker -H tcp://127.0.0.1:4243 -H unix:///var/run/docker.sock --storage-opt dm.basesize=2048Mb --debug</div><div class="line">ExecReload=/bin/kill -s HUP $MAINPID</div><div class="line">LimitNOFILE=infinity</div><div class="line">LimitNPROC=infinity</div><div class="line">LimitCORE=infinity</div><div class="line">TasksMax=infinity</div><div class="line">TimeoutStartSec=0</div><div class="line">Delegate=yes</div><div class="line">KillMode=process</div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></div><!-- fragment --><h4>Ssh login setup</h4>
<p>Ssh login must be enabled for root user (this is used to monitor disk usage of the container volumes)</p>
<p>in <b>config.ini</b></p>
<div class="fragment"><div class="line">[ssh]</div><div class="line">user: user</div><div class="line">password: password</div><div class="line">server: 192.168.98.99</div></div><!-- fragment --><p>User <b>must</b> have read wright in **/data/docker**</p>
<h2>API Reference</h2>
<p><a href="https://docs.google.com/spreadsheets/d/1dNXysy8pBEoM8M0qyzARihbboUXdAt57Yh3Idn2TWXc/edit?pli=1#gid=0">Api documentation and requests</a></p>
<h2>Tests</h2>
<p>In order to test the proxy, call curl commands</p>
<p>EX:</p>
<div class="fragment"><div class="line">curl -i -H &quot;secretkey:1234&quot; -H &quot;Content-Type: application/json&quot; -X POST -d &#39;{&quot;username&quot;:&quot;dan&quot;,&quot;password&quot;: &quot;123456789&quot;, &quot;options&quot;: {&quot;diskspace&quot;:&quot;512M&quot;,&quot;service&quot;:&quot;ssh&quot;}}&#39; http://localhost:5000/api/seedboxes/new/ssh1000</div></div><!-- fragment --><p>after, check if instance is running calling: <code>docker ps -a</code></p>
<p>If instance is running connect to it by using <code>ssh root@localhost -p port_value</code> Password is <b>screencast</b></p>
<h2>Contributors</h2>
<p>Dan</p>
<h2>License</h2>
<p>Use it on your own risk :) </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
